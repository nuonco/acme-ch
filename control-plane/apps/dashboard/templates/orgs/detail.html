{% extends "dashboard-base.html" %}

{% block breadcrumbs %}
<nav class="flex mb-4" aria-label="Breadcrumb">
  <ol class="inline-flex items-center space-x-1 md:space-x-2">
    <li class="inline-flex items-center">
      <a href="{% url 'index' %}" class="inline-flex items-center text-sm font-medium text-gray-400 hover:text-white">
        <svg class="w-3 h-3 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
          <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path>
        </svg>
        Organizations
      </a>
    </li>
    <li>
      <div class="flex items-center">
        <svg class="w-3 h-3 mx-1 text-gray-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
          <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
        </svg>
        <span class="ml-1 text-sm font-medium text-gray-300 md:ml-2">{{ object.name }}</span>
      </div>
    </li>
  </ol>
</nav>
{% endblock %}

{% block content %}
<div data-identifier="{{ object.identifier }}" id="{{ object.id }}">
    <div class="flex items-center justify-between mb-6">
        <h1 class="text-3xl font-bold text-white">Organization: {{ object.name }}</h1>
        {% if object.nuon_install_state %}
            {% if cluster_count == 0 %}
                <a href="{% url 'create-ch-cluster' object.slug %}" class="inline-flex items-center gap-2 rounded-md bg-indigo-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                    </svg>
                    Create CH Cluster
                </a>
            {% else %}
                <a href="{% url 'org-ch-clusters' object.slug %}" class="inline-flex items-center gap-2 rounded-md bg-gray-700 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-gray-600 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M5.25 14.25h13.5m-13.5 0a3 3 0 0 1-3-3m3 3a3 3 0 1 0 0 6h13.5a3 3 0 1 0 0-6m-16.5-3a3 3 0 0 1 3-3h13.5a3 3 0 0 1 3 3m-19.5 0a4.5 4.5 0 0 1 .9-2.7L5.737 5.1a3.375 3.375 0 0 1 2.7-1.35h7.126c1.062 0 2.062.5 2.7 1.35l2.587 3.45a4.5 4.5 0 0 1 .9 2.7m0 0a3 3 0 0 1-3 3m0 3h.008v.008h-.008v-.008Zm0-6h.008v.008h-.008v-.008Zm-3 6h.008v.008h-.008v-.008Zm0-6h.008v.008h-.008v-.008Z" />
                    </svg>
                    Show CH Clusters
                </a>
            {% endif %}
        {% endif %}
    </div>

    <div id="install-stats" class="bg-gray-900 mb-6">
        <div class="grid grid-cols-1 gap-px bg-white/10 sm:grid-cols-2 lg:grid-cols-4 rounded-lg overflow-hidden">
            <div class="bg-gray-900 px-4 py-6 sm:px-6 lg:px-8">
                <p class="text-sm font-medium text-gray-400">Name</p>
                <p class="mt-2 flex items-baseline gap-x-2">
                    <span class="text-sm font-mono font-semibold tracking-tight text-gray-500">{{ object.name }}</span>
                </p>
            </div>
            <div class="bg-gray-900 px-4 py-6 sm:px-6 lg:px-8">
                <p class="text-sm font-medium text-gray-400">Install ID</p>
                <p class="mt-2 flex items-baseline gap-x-2">
                    <span class="text-sm font-mono font-semibold tracking-tight text-gray-500">{{ object.nuon_install_id | default:"pending"}}</span>
                </p>
            </div>
            <div class="bg-gray-900 px-4 py-6 sm:px-6 lg:px-8">
                <p class="text-sm font-medium text-gray-400">Region</p>
                <p class="mt-2 flex items-baseline gap-x-2">
                    <span class="text-sm font-mono font-semibold tracking-tight text-gray-500">{{ object.get_region_display }}</span>
                </p>
            </div>
            <div class="bg-gray-900 px-4 py-6 sm:px-6 lg:px-8">
                <p class="text-sm font-medium text-gray-400">Created On</p>
                <p class="mt-2 flex items-baseline gap-x-2">
                    <span class="text-sm font-mono font-semibold tracking-tight text-gray-500">{{ object.created_on|date:"M d, Y" }}</span>
                </p>
            </div>
        </div>
    </div>

    {# Unified CTA - server-rendered with dynamic polling #}
    <div id="org-cta"
         hx-get="{% url 'org-detail-cta' object.slug %}"
         hx-trigger="load"
         hx-swap="outerHTML">
        <!-- Initial loading placeholder -->
        <div class="animate-pulse bg-gray-800/50 rounded-lg h-32 mb-6"></div>
    </div>

    {% comment %}Workflow Steps - refreshes every 5 seconds{% endcomment %}
    <div id="workflow-steps"
         class="mb-6"
         hx-get="{% url 'org-detail-workflow-steps' object.slug %}"
         hx-trigger="load, every 5s">
        <!-- Placeholder while loading -->
        <div class="bg-gray-800 shadow overflow-hidden sm:rounded-lg">
            <div class="px-4 py-5 sm:px-6">
                <h3 class="text-lg leading-6 font-medium text-white">Workflow Steps</h3>
                <p class="mt-1 text-sm text-gray-400">Loading...</p>
            </div>
        </div>
    </div>

    {% comment %}Add periodic refresh if the latest version is expired{% endcomment %}
    <div id="install-status"
         hx-get="{% url 'org-detail-install-status' object.slug %}"
         hx-trigger="load{% if object.nuon_latest_install_stack_version and object.nuon_latest_install_stack_version.composite_status.status == 'expired' %}, every 5s{% endif %}">
        <!-- Placeholder while loading -->
        <div class="bg-gray-800 shadow overflow-hidden sm:rounded-lg">
            <div class="px-4 py-5 sm:px-6 flex items-center justify-between">
                <h3 class="text-lg leading-6 font-medium text-white">Status</h3>
                <button
                    hx-get="{% url 'org-detail-install-status' object.slug %}"
                    hx-target="#install-status"
                    hx-swap="outerHTML"
                    class="inline-flex items-center gap-1.5 px-3 py-1.5 text-sm font-medium text-gray-300 bg-gray-700 rounded-md hover:bg-gray-600 transition">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                    <span>Refresh</span>
                </button>
            </div>
            <div class="border-t border-gray-700">
                <div class="px-4 py-5 sm:px-6">
                    <p class="text-sm text-gray-400">Loading...</p>
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}
