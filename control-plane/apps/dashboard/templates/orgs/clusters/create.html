{% extends "dashboard-base.html" %}

{% block title %}Create CH Cluster - {{ organization.name }} - Acme CH{% endblock %}

{% block header %}Create CH Cluster{% endblock %}

{% block breadcrumbs %}
<nav class="flex mb-4" aria-label="Breadcrumb">
  <ol class="inline-flex items-center space-x-1 md:space-x-2">
    <li class="inline-flex items-center">
      <a href="{% url 'index' %}" class="inline-flex items-center text-sm font-medium text-gray-400 hover:text-white">
        <svg class="w-3 h-3 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
          <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path>
        </svg>
        Organizations
      </a>
    </li>
    <li>
      <div class="flex items-center">
        <svg class="w-3 h-3 mx-1 text-gray-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
          <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
        </svg>
        <a href="{% url 'org-detail' organization.slug %}" class="ml-1 text-sm font-medium text-gray-400 hover:text-white md:ml-2">{{ organization.name }}</a>
      </div>
    </li>
    <li>
      <div class="flex items-center">
        <svg class="w-3 h-3 mx-1 text-gray-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
          <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
        </svg>
        <a href="{% url 'org-ch-clusters' organization.slug %}" class="ml-1 text-sm font-medium text-gray-400 hover:text-white md:ml-2">CH Clusters</a>
      </div>
    </li>
    <li>
      <div class="flex items-center">
        <svg class="w-3 h-3 mx-1 text-gray-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
          <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
        </svg>
        <span class="ml-1 text-sm font-medium text-gray-300 md:ml-2">Create CH Cluster</span>
      </div>
    </li>
  </ol>
</nav>
{% endblock %}

{% block content %}
<div class="mx-auto mb-8 rounded-lg bg-indigo-500/10 border border-indigo-500/20 p-6">
    <div class="flex items-start gap-4">
        <div class="flex-shrink-0">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-indigo-400">
                <path stroke-linecap="round" stroke-linejoin="round" d="M5.25 14.25h13.5m-13.5 0a3 3 0 0 1-3-3m3 3a3 3 0 1 0 0 6h13.5a3 3 0 1 0 0-6m-16.5-3a3 3 0 0 1 3-3h13.5a3 3 0 0 1 3 3m-19.5 0a4.5 4.5 0 0 1 .9-2.7L5.737 5.1a3.375 3.375 0 0 1 2.7-1.35h7.126c1.062 0 2.062.5 2.7 1.35l2.587 3.45a4.5 4.5 0 0 1 .9 2.7m0 0a3 3 0 0 1-3 3m0 3h.008v.008h-.008v-.008Zm0-6h.008v.008h-.008v-.008Zm-3 6h.008v.008h-.008v-.008Zm0-6h.008v.008h-.008v-.008Z" />
            </svg>
        </div>
        <div class="flex-1">
            <h2 class="text-lg font-semibold leading-7 text-indigo-300">Create a New CH Cluster</h2>
            <p class="mt-2 text-sm leading-6 text-gray-300">
                Create a CH cluster for <span class="font-medium text-white">{{ organization.name }}</span>. CH Clusters are immutable once created and can only be deleted.
            </p>

            <!-- Immutability Warning -->
            <div class="mt-4 rounded-lg bg-yellow-500/10 border border-yellow-500/20 p-3">
                <div class="flex items-start gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-yellow-400 flex-shrink-0 mt-0.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" />
                    </svg>
                    <div class="flex-1">
                        <p class="text-xs text-yellow-300 font-medium">Important</p>
                        <p class="text-xs text-gray-300 mt-1">
                            CH Cluster names are permanent and cannot be changed after creation. The name will be automatically converted to a URL-friendly slug following RFC 1123 conventions.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Immutability Details -->
            <div class="mt-4 rounded-lg bg-blue-500/10 border border-blue-500/20 p-3">
                <div class="flex items-start gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-blue-400 flex-shrink-0 mt-0.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="m11.25 11.25.041-.02a.75.75 0 0 1 1.063.852l-.708 2.836a.75.75 0 0 0 1.063.853l.041-.021M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9-3.75h.008v.008H12V8.25Z" />
                    </svg>
                    <div class="flex-1">
                        <p class="text-xs text-blue-300 font-medium mb-1">CH Cluster Immutability</p>
                        <p class="text-xs text-gray-300 mb-2">
                            Once created, CH clusters cannot be modified. If you need to make changes, you'll need to delete the CH cluster and create a new one.
                        </p>
                        <ul class="text-xs text-gray-400 space-y-0.5 list-disc list-inside">
                            <li>All CH cluster settings are permanent</li>
                            <li>Slugs are auto-generated and follow RFC 1123 naming conventions</li>
                            <li>Only deletion is supported for existing CH clusters</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<form method="post">
  {% csrf_token %}

  {% if form.non_field_errors %}
  <div class="rounded-md bg-red-50 p-4 mb-6">
    <div class="flex">
      <div class="ml-3">
        <h3 class="text-sm font-medium text-red-800">There were errors with your submission</h3>
        <div class="mt-2 text-sm text-red-700">{{ form.non_field_errors }}</div>
      </div>
    </div>
  </div>
  {% endif %}

  <div class="space-y-12">
    <!-- CH Cluster Details Section -->
    <div class="grid grid-cols-1 gap-x-8 gap-y-10 border-b border-white/10 pb-12 md:grid-cols-3">
      <div>
        <h2 class="text-base/7 font-semibold text-white">CH Cluster Details</h2>
        <p class="mt-1 text-sm/6 text-gray-400">Choose a unique name for your CH cluster. The name will be used to identify this CH cluster within your organization.</p>
      </div>

      <div class="grid max-w-2xl grid-cols-1 gap-x-6 gap-y-8 sm:grid-cols-6 md:col-span-2">
        <!-- Name Field -->
        <div class="sm:col-span-4">
          <label for="{{ form.name.id_for_label }}" class="block text-sm/6 font-medium text-white">CH Cluster Name</label>
          <div class="mt-2">
            <input type="text" name="{{ form.name.name }}" id="{{ form.name.id_for_label }}" value="{{ form.name.value|default:'' }}" class="block w-full rounded-md bg-white/5 px-3 py-1.5 text-base text-white outline-1 -outline-offset-1 outline-white/10 placeholder:text-gray-500 focus:outline-2 focus:-outline-offset-2 focus:outline-indigo-500 sm:text-sm/6" required>
          </div>
          <p class="mt-2 text-xs text-gray-400">
            A descriptive name for your CH cluster. The slug will be automatically generated from this name following RFC 1123 conventions (lowercase alphanumeric characters and hyphens).
          </p>
          {% if form.name.errors %}
          <p class="mt-2 text-sm text-red-400">{{ form.name.errors.0 }}</p>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- CH Cluster Configuration Section -->
    <div class="grid grid-cols-1 gap-x-8 gap-y-10 border-b border-white/10 pb-12 md:grid-cols-3">
      <div>
        <h2 class="text-base/7 font-semibold text-white">CH Cluster Configuration</h2>
        <p class="mt-1 text-sm/6 text-gray-400">Choose the deployment topology for your CH cluster.</p>
      </div>

      <div class="grid max-w-2xl grid-cols-1 gap-x-6 gap-y-8 sm:grid-cols-6 md:col-span-2">
        <!-- CH Cluster Type Field -->
        <div class="sm:col-span-4">
          <label for="{{ form.cluster_type.id_for_label }}" class="block text-sm/6 font-medium text-white">CH Cluster Type</label>
          <div class="mt-2 grid grid-cols-1">
            <select id="{{ form.cluster_type.id_for_label }}" name="{{ form.cluster_type.name }}" class="col-start-1 row-start-1 w-full appearance-none rounded-md bg-white/5 py-1.5 pl-3 pr-8 text-base text-white outline-1 -outline-offset-1 outline-white/10 focus:outline-2 focus:-outline-offset-2 focus:outline-indigo-500 sm:text-sm/6 [&_*]:text-black">
              {% for value, label in form.cluster_type.field.choices %}
              <option value="{{ value }}" {% if form.cluster_type.value == value %}selected{% endif %}>{{ label }}</option>
              {% endfor %}
            </select>
            <svg class="pointer-events-none col-start-1 row-start-1 mr-2 size-5 self-center justify-self-end text-gray-400 sm:size-4" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true">
              <path fill-rule="evenodd" d="M4.22 6.22a.75.75 0 0 1 1.06 0L8 8.94l2.72-2.72a.75.75 0 1 1 1.06 1.06l-3.25 3.25a.75.75 0 0 1-1.06 0L4.22 7.28a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" />
            </svg>
          </div>
          <p class="mt-2 text-xs text-gray-400">
            Choose the CH cluster deployment topology based on your workload requirements.
          </p>
          {% if form.cluster_type.errors %}
          <p class="mt-2 text-sm text-red-400">{{ form.cluster_type.errors.0 }}</p>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Connectivity Section -->
    <div class="grid grid-cols-1 gap-x-8 gap-y-10 border-b border-white/10 pb-12 md:grid-cols-3">
      <div>
        <h2 class="text-base/7 font-semibold text-white">Connectivity</h2>
        <p class="mt-1 text-sm/6 text-gray-400">Configure network access and connectivity options for your cluster.</p>
      </div>

      <div class="grid max-w-2xl grid-cols-1 gap-x-6 gap-y-8 sm:grid-cols-6 md:col-span-2">
        <!-- Ingress Type Field -->
        <div class="sm:col-span-4">
          <label for="{{ form.ingress_type.id_for_label }}" class="block text-sm/6 font-medium text-white">Ingress Type</label>
          <div class="mt-2 grid grid-cols-1">
            <select id="{{ form.ingress_type.id_for_label }}" name="{{ form.ingress_type.name }}" class="col-start-1 row-start-1 w-full appearance-none rounded-md bg-white/5 py-1.5 pl-3 pr-8 text-base text-white outline-1 -outline-offset-1 outline-white/10 focus:outline-2 focus:-outline-offset-2 focus:outline-indigo-500 sm:text-sm/6 [&_*]:text-black" onchange="updateIngressHelperText(this.value)">
              {% for value, label in form.ingress_type.field.choices %}
              <option value="{{ value }}" {% if form.ingress_type.value == value %}selected{% endif %} {% if value == 'tailnet_ingress' and not organization.deploy_tailscale %}disabled{% endif %}>{{ label }}{% if value == 'tailnet_ingress' and not organization.deploy_tailscale %} (Requires Tailscale){% endif %}</option>
              {% endfor %}
            </select>
            <svg class="pointer-events-none col-start-1 row-start-1 mr-2 size-5 self-center justify-self-end text-gray-400 sm:size-4" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true">
              <path fill-rule="evenodd" d="M4.22 6.22a.75.75 0 0 1 1.06 0L8 8.94l2.72-2.72a.75.75 0 1 1 1.06 1.06l-3.25 3.25a.75.75 0 0 1-1.06 0L4.22 7.28a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" />
            </svg>
          </div>
          <p class="mt-2 text-xs text-gray-400">
            Configure how the cluster will be accessed from outside the Kubernetes environment.
          </p>
          {% if form.ingress_type.errors %}
          <p class="mt-2 text-sm text-red-400">{{ form.ingress_type.errors.0 }}</p>
          {% endif %}
          {% if not organization.deploy_tailscale %}
          <p class="mt-2 text-xs text-yellow-400">
            Note: Tailscale ingress is disabled because Tailscale was not enabled during organization creation.
          </p>
          {% endif %}

          <!-- Dynamic Helper Text for Ingress Types -->
          <div id="ingress-helper-no-ingress" class="mt-3 rounded-lg bg-yellow-500/10 border border-yellow-500/20 p-3 hidden">
            <div class="flex items-start gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 text-yellow-400 flex-shrink-0 mt-0.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" />
              </svg>
              <div class="flex-1">
                <p class="text-xs text-yellow-300 font-medium">Limited Connectivity</p>
                <p class="text-xs text-gray-300 mt-1">
                  With no ingress configured, you will not be able to query this cluster from the control plane. The cluster will only be accessible from within the Kubernetes environment.
                </p>
              </div>
            </div>
          </div>

          <div id="ingress-helper-tailnet" class="mt-3 rounded-lg bg-blue-500/10 border border-blue-500/20 p-3 hidden">
            <div class="flex items-start gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 text-blue-400 flex-shrink-0 mt-0.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="m11.25 11.25.041-.02a.75.75 0 0 1 1.063.852l-.708 2.836a.75.75 0 0 0 1.063.853l.041-.021M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9-3.75h.008v.008H12V8.25Z" />
              </svg>
              <div class="flex-1">
                {% if organization.deploy_tailscale %}
                <p class="text-xs text-blue-300 font-medium">Tailscale Configured</p>
                <p class="text-xs text-gray-300 mt-1">
                  Tailscale was enabled during organization creation. Your cluster will be accessible via your Tailscale network once the Tailscale operator is deployed.
                </p>
                {% else %}
                <p class="text-xs text-yellow-300 font-medium">Tailscale Not Available</p>
                <p class="text-xs text-gray-300 mt-1">
                  Tailscale ingress is not available because it was not enabled during organization creation. To use Tailscale, you'll need to create a new organization with Tailscale enabled.
                </p>
                {% endif %}
              </div>
            </div>
          </div>

          <div id="ingress-helper-public" class="mt-3 rounded-lg bg-red-500/10 border border-red-500/20 p-3 hidden">
            <div class="flex items-start gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 text-red-400 flex-shrink-0 mt-0.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" />
              </svg>
              <div class="flex-1">
                <p class="text-xs text-red-300 font-medium">Security Warning</p>
                <p class="text-xs text-gray-300 mt-1">
                  Public ingress exposes your cluster to the internet. Keep your credentials safe and ensure you have proper authentication and authorization configured. Consider using IP allowlisting or other security measures.
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="mt-6 flex items-center justify-end gap-x-6">
    <a href="{% url 'org-ch-clusters' organization.slug %}" class="text-sm/6 font-semibold text-white hover:text-gray-300">Cancel</a>
    <button type="submit" class="rounded-md bg-indigo-500 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-400 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-500">Create CH Cluster</button>
  </div>
</form>

<script>
function updateIngressHelperText(ingressType) {
  // Hide all helper text divs
  document.getElementById('ingress-helper-no-ingress').classList.add('hidden');
  document.getElementById('ingress-helper-tailnet').classList.add('hidden');
  document.getElementById('ingress-helper-public').classList.add('hidden');

  // Show the relevant helper text based on the selected ingress type
  if (ingressType === 'no_ingress') {
    document.getElementById('ingress-helper-no-ingress').classList.remove('hidden');
  } else if (ingressType === 'tailnet_ingress') {
    document.getElementById('ingress-helper-tailnet').classList.remove('hidden');
  } else if (ingressType === 'public_ingress') {
    document.getElementById('ingress-helper-public').classList.remove('hidden');
  }
}

// Show the appropriate helper text on page load
document.addEventListener('DOMContentLoaded', function() {
  const ingressSelect = document.getElementById('{{ form.ingress_type.id_for_label }}');
  if (ingressSelect) {
    updateIngressHelperText(ingressSelect.value);
  }
});
</script>
{% endblock %}
